<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'unsafe-inline'; script-src 'self' 'unsafe-inline'" />
  <title>Auto Typer</title>
  <style>
    :root {
      --bg: #090909;
      --panel: #111111;
      --line: #2a2a2a;
      --line-strong: #444444;
      --text: #f4f4f4;
      --muted: #a3a3a3;
      --ok: #f4f4f4;
      --warn: #d8d8d8;
      --danger: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: transparent;
      color: var(--text);
      user-select: none;
    }

    .shell {
      height: 100vh;
      width: 100vw;
      background: var(--bg);
      border: 1px solid var(--line-strong);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .titlebar {
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px 0 14px;
      border-bottom: 1px solid var(--line);
      -webkit-app-region: drag;
      background: #0d0d0d;
    }

    .brand {
      font-size: 12px;
      letter-spacing: 0.16em;
      color: var(--text);
      font-weight: 700;
    }

    .wcontrols {
      display: flex;
      gap: 6px;
      -webkit-app-region: no-drag;
    }

    .wcontrols button {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      border: 1px solid var(--line);
      background: #131313;
      color: var(--text);
      cursor: pointer;
    }

    .wcontrols button:hover { border-color: var(--line-strong); background: #181818; }

    .content {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      -webkit-app-region: no-drag;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      display: block;
      margin-bottom: 5px;
    }

    textarea,
    input[type="number"],
    input[type="text"] {
      width: 100%;
      border-radius: 9px;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
    }

    textarea {
      min-height: 135px;
      resize: vertical;
      max-height: 220px;
      line-height: 1.4;
    }

    textarea:focus,
    input:focus { border-color: var(--line-strong); }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .hotkey-input {
      text-align: center;
      cursor: pointer;
      caret-color: transparent;
      font-weight: 600;
    }

    .hotkey-input.capturing { border-color: #888; }

    .row-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border: 1px solid var(--line);
      border-radius: 9px;
      padding: 9px 10px;
      background: #0e0e0e;
    }

    .checkbox-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    input[type="checkbox"] {
      accent-color: #ffffff;
      width: 16px;
      height: 16px;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      border: 1px solid var(--line);
      background: #141414;
      color: var(--text);
      border-radius: 9px;
      padding: 10px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .btn:hover { border-color: var(--line-strong); background: #1a1a1a; }

    .btn-launch { flex: 1; }

    .btn-launch.stop {
      border-color: #777;
      background: #1d1d1d;
    }

    .progress-wrap {
      margin-top: 2px;
      height: 5px;
      border-radius: 999px;
      background: #1a1a1a;
      overflow: hidden;
      border: 1px solid var(--line);
    }

    .progress-bar {
      width: 0%;
      height: 100%;
      background: #ffffff;
      transition: width 0.15s linear;
    }

    .status {
      border-radius: 9px;
      border: 1px solid var(--line);
      padding: 9px 10px;
      font-size: 12px;
      text-align: center;
      color: var(--muted);
      background: #0e0e0e;
      min-height: 36px;
    }

    .status.typing,
    .status.done,
    .status.error,
    .status.stopped { color: var(--text); border-color: var(--line-strong); }

    kbd {
      border: 1px solid var(--line-strong);
      background: #1a1a1a;
      border-radius: 4px;
      padding: 1px 5px;
      font-size: 11px;
      color: var(--text);
    }

    .footer {
      margin-top: 2px;
      font-size: 11px;
      color: #888;
      text-align: center;
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="titlebar">
    <span class="brand">AUTO TYPER</span>
    <div class="wcontrols">
      <button onclick="window.api.minimize()" title="Minimize">─</button>
      <button onclick="window.api.close()" title="Close">✕</button>
    </div>
  </div>

  <div class="content">
    <div>
      <label for="text">Text</label>
      <textarea id="text" placeholder="Type or paste text..." spellcheck="false"></textarea>
    </div>

    <div class="grid">
      <div>
        <label for="speed">Base chars/sec</label>
        <input type="number" id="speed" value="20" min="1" max="500" step="1" />
      </div>
      <div>
        <label for="hotkey">Hotkey</label>
        <input type="text" id="hotkey" class="hotkey-input" value="F2" readonly title="Click to rebind" />
      </div>
    </div>

    <div class="row-inline">
      <div class="checkbox-wrap">
        <input type="checkbox" id="humanized" checked />
        <label for="humanized" style="margin:0;">Humanized timing</label>
      </div>
      <button class="btn" id="aotBtn" title="Always on top">AOT ON</button>
    </div>

    <div class="grid">
      <div>
        <label for="pauseEveryMin">Pause every (min chars)</label>
        <input type="number" id="pauseEveryMin" value="1" min="1" max="15" step="1" />
      </div>
      <div>
        <label for="pauseEveryMax">Pause every (max chars)</label>
        <input type="number" id="pauseEveryMax" value="15" min="1" max="15" step="1" />
      </div>
      <div>
        <label for="pauseMsMin">Pause length min (ms)</label>
        <input type="number" id="pauseMsMin" value="80" min="20" max="5000" step="10" />
      </div>
      <div>
        <label for="pauseMsMax">Pause length max (ms)</label>
        <input type="number" id="pauseMsMax" value="420" min="20" max="8000" step="10" />
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-launch" id="startBtn">START</button>
    </div>

    <div class="progress-wrap"><div class="progress-bar" id="progress"></div></div>

    <div class="status idle" id="status">
      Press <kbd>F2</kbd> in target window to type · <kbd>ESC</kbd> to abort
    </div>

    <div class="footer">Black + white UI • variable speed bursts • random pauses • occasional typo corrections</div>
  </div>
</div>

<script>
const textEl = document.getElementById("text");
const speedEl = document.getElementById("speed");
const hotkeyEl = document.getElementById("hotkey");
const humanizedEl = document.getElementById("humanized");
const pauseEveryMinEl = document.getElementById("pauseEveryMin");
const pauseEveryMaxEl = document.getElementById("pauseEveryMax");
const pauseMsMinEl = document.getElementById("pauseMsMin");
const pauseMsMaxEl = document.getElementById("pauseMsMax");
const startBtn = document.getElementById("startBtn");
const aotBtn = document.getElementById("aotBtn");
const statusEl = document.getElementById("status");
const progressEl = document.getElementById("progress");

let typing = false;
let capturing = false;

function num(el, fallback) {
  const parsed = Number.parseInt(el.value, 10);
  return Number.isFinite(parsed) ? parsed : fallback;
}

function syncPauseRanges() {
  const minChars = Math.max(1, Math.min(15, num(pauseEveryMinEl, 1)));
  const maxChars = Math.max(minChars, Math.min(15, num(pauseEveryMaxEl, 15)));
  pauseEveryMinEl.value = minChars;
  pauseEveryMaxEl.value = maxChars;

  const minMs = Math.max(20, Math.min(5000, num(pauseMsMinEl, 80)));
  const maxMs = Math.max(minMs, Math.min(8000, num(pauseMsMaxEl, 420)));
  pauseMsMinEl.value = minMs;
  pauseMsMaxEl.value = maxMs;
}

pauseEveryMinEl.addEventListener("change", syncPauseRanges);
pauseEveryMaxEl.addEventListener("change", syncPauseRanges);
pauseMsMinEl.addEventListener("change", syncPauseRanges);
pauseMsMaxEl.addEventListener("change", syncPauseRanges);

hotkeyEl.addEventListener("click", () => {
  capturing = true;
  hotkeyEl.value = "...";
  hotkeyEl.classList.add("capturing");
});

document.addEventListener("keydown", async (e) => {
  if (!capturing) return;
  e.preventDefault();
  capturing = false;
  hotkeyEl.classList.remove("capturing");
  const key = mapKey(e);
  hotkeyEl.value = key;
  const ok = await window.api.registerHotkey(key);
  if (!ok) {
    statusEl.className = "status error";
    statusEl.innerHTML = `Failed to bind <kbd>${key}</kbd> — try another`;
  } else {
    statusEl.className = "status idle";
    statusEl.innerHTML = `Press <kbd>${key}</kbd> in target window to type · <kbd>ESC</kbd> to abort`;
  }
});

function mapKey(e) {
  const map = { " ": "Space", ArrowUp: "Up", ArrowDown: "Down", ArrowLeft: "Left", ArrowRight: "Right" };
  let key = map[e.key] || e.key;
  if (/^F\d+$/.test(key)) return key;
  if (key.length === 1) key = key.toUpperCase();
  let combo = "";
  if (e.ctrlKey) combo += "CommandOrControl+";
  if (e.altKey) combo += "Alt+";
  if (e.shiftKey && key.length > 1) combo += "Shift+";
  return combo + key;
}

startBtn.addEventListener("click", () => {
  if (typing) {
    window.api.stopTyping();
  } else {
    sendText();
  }
});

function sendText() {
  const text = textEl.value;
  const speed = Number.parseFloat(speedEl.value) || 20;
  syncPauseRanges();

  if (!text.trim()) {
    statusEl.className = "status error";
    statusEl.textContent = "No text entered.";
    return;
  }

  progressEl.style.width = "0%";

  const options = {
    humanized: humanizedEl.checked,
    pauseEveryMin: num(pauseEveryMinEl, 1),
    pauseEveryMax: num(pauseEveryMaxEl, 15),
    pauseMsMin: num(pauseMsMinEl, 80),
    pauseMsMax: num(pauseMsMaxEl, 420),
  };

  window.api.startTyping(text, speed, options);
}

window.api.onRequestText(() => sendText());

window.api.onTypingStatus((d) => {
  const key = hotkeyEl.value;
  switch (d.state) {
    case "typing":
      typing = true;
      startBtn.textContent = "STOP";
      startBtn.classList.add("stop");
      statusEl.className = "status typing";
      if (d.total) {
        const pct = Math.round((d.done / d.total) * 100);
        statusEl.textContent = `Typing... ${pct}%`;
        progressEl.style.width = pct + "%";
      } else {
        statusEl.textContent = "Typing...";
      }
      break;
    case "done":
      typing = false;
      startBtn.textContent = "START";
      startBtn.classList.remove("stop");
      statusEl.className = "status done";
      statusEl.innerHTML = `Done · press <kbd>${key}</kbd> to run again`;
      progressEl.style.width = "100%";
      setTimeout(() => { progressEl.style.width = "0%"; }, 1800);
      break;
    case "stopped":
      typing = false;
      startBtn.textContent = "START";
      startBtn.classList.remove("stop");
      statusEl.className = "status stopped";
      statusEl.textContent = "Typing stopped.";
      progressEl.style.width = "0%";
      break;
    case "error":
      typing = false;
      startBtn.textContent = "START";
      startBtn.classList.remove("stop");
      statusEl.className = "status error";
      statusEl.textContent = "Failed to send keys. Make sure a target window is focused.";
      progressEl.style.width = "0%";
      break;
  }
});

let aot = true;
aotBtn.addEventListener("click", async () => {
  aot = await window.api.toggleAOT();
  aotBtn.textContent = aot ? "AOT ON" : "AOT OFF";
});
</script>
</body>
</html>
